var THREEx=THREEx||{};THREEx.JsonPlayer=function(){var _this=this;_this.records=null;_this._onNewRecord=function(newRecord){};_this.playbackRate=1;this.currentTime=null;this.paused=false;this.start=function(){console.assert(this.isStarted()===false);_this.currentTime=0;_this.paused=false;onCurrentTimeChange()};this.stop=function(){_this.currentTime=null;_this.paused=false};this.isStarted=function(){return _this.currentTime!==null?true:false};this.pause=function(onOff){_this.paused=onOff};this.update=function(deltaTime){if(this.isStarted()===false)return;if(_this.paused===false){_this.currentTime+=deltaTime*_this.playbackRate}onCurrentTimeChange()};this.onCurrentTimeChange=onCurrentTimeChange;return;function onCurrentTimeChange(){if(_this.records===null)return;var timestamp=_this.records.startedAt+_this.currentTime*1e3;var values=_this.records.values;for(var i=0;i<values.length;i++){if(i+1>=values.length)break;if(values[i+1].recordedAt>timestamp){_this._onNewRecord(values[i].data);break}}}};THREEx.JsonPlayer.prototype.load=function(urls,onLoaded){var _this=this;loadNextUrl();return;function loadNextUrl(){if(urls.length===0){onLoaded();return}var url=urls.shift();doHttpRequest(url,function(content){var loadedRecords=JSON.parse(content);if(_this.records===null){_this.records=loadedRecords}else{_this.records.values.push.apply(_this.records.values,loadedRecords.values)}loadNextUrl()})}return;function doHttpRequest(url,onLoaded){var request=new XMLHttpRequest;request.addEventListener("load",function(){onLoaded(this.responseText)});request.open("GET",url);request.send()}};var THREEx=THREEx||{};THREEx.JsonRecorder=function(){var _this=this;_this._fetchNewRecordData=function(){return"newRecord"};this.autoSave=true;this.autoSaveMaxLength=1e3;this.autoSaveBaseName="jsonrecords";this.updatePeriod=1e3/100;var autoSaveCounter=0;var records={startedAt:null,values:[]};var timerId=null;this.start=function(){records.startedAt=Date.now();console.assert(timerId===null);timerId=setInterval(update,_this.updatePeriod);return this};this.stop=function(){if(_this.autoSave===true)autoSave();autoSaveCounter=0;clearInterval(timerId);timerId=null;return this};return;function update(){var recordData=_this._fetchNewRecordData();records.values.push({recordedAt:Date.now(),data:recordData});if(_this.autoSave===true&&records.values.length>=_this.autoSaveMaxLength){autoSave()}}function autoSave(){var basename=_this.autoSaveBaseName+pad(autoSaveCounter,4)+".json";var jsonString=JSON.stringify(records,null,"	");download(jsonString,basename,"application/json");autoSaveCounter++;records.startedAt=Date.now();records.values=[]}function pad(num,size){var s=num+"";while(s.length<size)s="0"+s;return s}};var THREEx=THREEx||{};THREEx.WebvrPlayer=function(){THREEx.JsonPlayer.call(this);this.frameData=null;this._onNewRecord=function(newRecord){console.log("update frameData");this.frameData=newRecord}};THREEx.WebvrPlayer.prototype=Object.create(THREEx.JsonPlayer.prototype);THREEx.WebvrPlayer.prototype.constructor=THREEx.WebvrPlayer;var THREEx=THREEx||{};THREEx.GamepadPlayer=function(){THREEx.JsonPlayer.call(this);this.gamepads=[null,null,null,null];this._onNewRecord=function(newRecord){this.gamepads=newRecord}};THREEx.GamepadPlayer.prototype=Object.create(THREEx.JsonPlayer.prototype);THREEx.GamepadPlayer.prototype.constructor=THREEx.GamepadPlayer;var THREEx=THREEx||{};THREEx.WebvrRecorder=function(){THREEx.JsonRecorder.call(this);this.autoSaveBaseName="webvrrecords";var frameData=new VRFrameData;this._fetchNewRecordData=function(newRecord){this._vrDisplay.getFrameData(frameData);var frameDataJSON=JSON.parse(JSON.stringify(frameData));return frameDataJSON};this._vrDisplay=null;this.setVRDisplay=function(vrDisplay){this._vrDisplay=vrDisplay;return this}};THREEx.WebvrRecorder.prototype=Object.create(THREEx.JsonRecorder.prototype);THREEx.WebvrRecorder.prototype.constructor=THREEx.WebvrRecorder;var THREEx=THREEx||{};THREEx.GamepadRecorder=function(){THREEx.JsonRecorder.call(this);this.autoSaveBaseName="gamepadrecords";this._fetchNewRecordData=function(newRecord){var gamepads=navigator.getGamepads();gamepads=THREEx.GamepadRecorder._cloneObject(gamepads);return gamepads};return};THREEx.GamepadRecorder.prototype=Object.create(THREEx.JsonRecorder.prototype);THREEx.GamepadRecorder.prototype.constructor=THREEx.GamepadRecorder;THREEx.GamepadRecorder._cloneObject=function(item){if(!item){return item}var types=[Number,String,Boolean],result;types.forEach(function(type){if(item instanceof type){result=type(item)}});if(typeof result=="undefined"){if(Object.prototype.toString.call(item)==="[object Array]"){result=[];item.forEach(function(child,index,array){result[index]=this._cloneObject(child)})}else if(typeof item=="object"){if(item.nodeType&&typeof item.cloneNode=="function"){var result=item.cloneNode(true)}else if(!item.prototype){if(item instanceof Date){result=new Date(item)}else{result={};for(var i in item){result[i]=this._cloneObject(item[i])}}}else{if(false&&item.constructor){result=new item.constructor}else{result=item}}}else{result=item}}return result};var THREEx=THREEx||{};THREEx.VRPlayer=function(){this.vrExperience=null;this._playbackRate=1;this.videoElement=document.createElement("video");this.videoElement.style.position="absolute";this.videoElement.style.top="0px";this.videoElement.style.zIndex="-1";this.videoElement.muted=true;this.videoElement.playbackRate=this._playbackRate;document.body.appendChild(this.videoElement);this._webvrPlayer=new THREEx.WebvrPlayer;this._webvrPlayer.playbackRate=this._playbackRate;this._gamepadPlayer=new THREEx.GamepadPlayer;this._gamepadPlayer.playbackRate=this._playbackRate};THREEx.VRPlayer.prototype.setPlaybackRate=function(playbackRate){this._playbackRate=playbackRate;this.videoElement.playbackRate=playbackRate;this._webvrPlayer.playbackRate=playbackRate;this._gamepadPlayer.playbackRate=playbackRate;return this};THREEx.VRPlayer.prototype.load=function(path,basename,onLoaded){var _this=this;doHttpRequest(path+basename,function(data){var vrExperience=JSON.parse(data);_this.vrExperience=vrExperience;_this.path=path;var webvrUrls=[];for(var i=0;i<_this.vrExperience.nWebvrFiles;i++){webvrUrls.push(_this.path+_this.vrExperience.webvrBaseUrl+pad(i,4)+".json")}var webvrLoaded=false;_this._webvrPlayer.load(webvrUrls,function(){webvrLoaded=true;if(webvrLoaded&&gamepadLoaded)onLoaded()});var gamepadUrls=[];for(var i=0;i<_this.vrExperience.nGamepadFiles;i++){gamepadUrls.push(_this.path+_this.vrExperience.gamepadBaseUrl+pad(i,4)+".json")}var gamepadLoaded=false;_this._gamepadPlayer.load(gamepadUrls,function(){gamepadLoaded=true;if(webvrLoaded&&gamepadLoaded)onLoaded()})});return this;function doHttpRequest(url,onLoaded){var request=new XMLHttpRequest;request.addEventListener("load",function(){onLoaded(this.responseText)});request.open("GET",url);request.send()}function pad(num,size){var string=num+"";while(string.length<size)string="0"+string;return string}};THREEx.VRPlayer.prototype.start=function(){var _this=this;this.videoElement.src=this.path+this.vrExperience.videoSrc;document.body.appendChild(this.videoElement);if(_this._webvrPlayer.records)_this._webvrPlayer.start();if(_this._gamepadPlayer.records)_this._gamepadPlayer.start();setTimeout(function(){_this.videoElement.currentTime=0;_this.videoElement.play()},_this.vrExperience.videoToGamepadDelay*1e3);navigator.getGamepads=function(){return _this._gamepadPlayer.gamepads};return this};THREEx.VRPlayer.prototype.isStarted=function(){return this._gamepadPlayer.isStarted()};THREEx.VRPlayer.prototype.isPaused=function(){return this._gamepadPlayer.paused};THREEx.VRPlayer.prototype.getCurrentTime=function(){return this.videoElement.currentTime};THREEx.VRPlayer.prototype.setCurrentTime=function(currentTime){this.videoElement.currentTime=currentTime;this._webvrPlayer.currentTime=currentTime-this.vrExperience.videoToWebvrDelay;this._webvrPlayer.onCurrentTimeChange();this._gamepadPlayer.currentTime=currentTime-this.vrExperience.videoToGamepadDelay;this._gamepadPlayer.onCurrentTimeChange()};THREEx.VRPlayer.prototype.seek=function(delta){var currentTime=this.videoElement.currentTime;currentTime+=delta;this.setCurrentTime(currentTime)};THREEx.VRPlayer.prototype.pause=function(value){if(value===undefined){value=this._gamepadPlayer.paused?false:true}this._webvrPlayer.pause(value);this._gamepadPlayer.pause(value);if(value===true){this.videoElement.pause()}else{if(this.videoElement.paused){this.videoElement.play()}}};THREEx.VRPlayer.prototype.update=function(deltaTime){this._webvrPlayer.update(deltaTime);this._gamepadPlayer.update(deltaTime)};var THREEx=THREEx||{};THREEx.VRPlayerUI=function(vrPlayer){this.vrPlayer=vrPlayer;this.domElement=document.createElement("div");this.domElement.style.margin="0.5em";this.domElement.style.position="absolute";this.domElement.style.top="0px";this.domElement.style.left="0px";var startButton=document.createElement("button");startButton.innerHTML="start";this.domElement.appendChild(startButton);startButton.addEventListener("click",function(){vrPlayer.start()});var pauseButton=document.createElement("button");pauseButton.innerHTML="pause";this.domElement.appendChild(pauseButton);pauseButton.addEventListener("click",function(){vrPlayer.pause()});this.domElement.appendChild(document.createElement("br"));var seekMinusOneButton=document.createElement("button");seekMinusOneButton.innerHTML="seek -1sec";this.domElement.appendChild(seekMinusOneButton);seekMinusOneButton.addEventListener("click",function(){vrPlayer.seek(-1)});var seekPlusOneButton=document.createElement("button");seekPlusOneButton.innerHTML="seek +1sec";this.domElement.appendChild(seekPlusOneButton);seekPlusOneButton.addEventListener("click",function(){vrPlayer.seek(+1)});this.domElement.appendChild(document.createElement("br"));var labelElement=document.createElement("label");labelElement.innerHTML="current time : ";this.domElement.appendChild(labelElement);var currentTimeValue=document.createElement("span");currentTimeValue.innerHTML="n/a";labelElement.appendChild(currentTimeValue);this.domElement.appendChild(document.createElement("br"));var labelElement=document.createElement("label");labelElement.innerHTML="video duration : ";this.domElement.appendChild(labelElement);var videoDurationValue=document.createElement("span");videoDurationValue.innerHTML="n/a";labelElement.appendChild(videoDurationValue);this.domElement.appendChild(document.createElement("br"));var labelElement=document.createElement("label");labelElement.innerHTML="gamepad time offset : ";this.domElement.appendChild(labelElement);var gamepadTimeOffsetValue=document.createElement("span");gamepadTimeOffsetValue.innerHTML="n/a";labelElement.appendChild(gamepadTimeOffsetValue);this.domElement.appendChild(document.createElement("br"));var labelElement=document.createElement("label");labelElement.innerHTML="gamepad time offset : ";this.domElement.appendChild(labelElement);var gamepadTimeOffsetInput=document.createElement("input");gamepadTimeOffsetInput.size="4";gamepadTimeOffsetInput.innerHTML="n/a";labelElement.appendChild(gamepadTimeOffsetInput);gamepadTimeOffsetInput.addEventListener("change",function(){var value=parseFloat(gamepadTimeOffsetInput.value);vrPlayer.vrExperience.videoToGamepadDelay=value;vrPlayer.seek(0)});this.update=function(){if(vrPlayer.isStarted()){startButton.disabled=true}else{startButton.disabled=false}currentTimeValue.innerHTML=vrPlayer.getCurrentTime().toFixed(2)+"sec";if(vrPlayer.vrExperience!==null){gamepadTimeOffsetValue.innerHTML=vrPlayer.vrExperience.videoToGamepadDelay}videoDurationValue.innerHTML=vrPlayer.videoElement.duration.toFixed(2)+"sec"}};var THREEx=THREEx||{};THREEx.VRRecorder=function(options){options=options||{};options.gamepad=options.gamepad!==undefined?options.gamepad:true;options.webvr=options.webvr!==undefined?options.webvr:true;if(options.gamepad===true){this._gamepadRecorder=new THREEx.GamepadRecorder}else{this._gamepadRecorder=null}if(options.webvr===true){this._webvrRecorder=new THREEx.WebvrRecorder}else{this._webvrRecorder=null}};THREEx.VRRecorder.prototype.start=function(){var _this=this;if(_this._gamepadRecorder!==null){_this._gamepadRecorder.start()}if(_this._webvrRecorder!==null){navigator.getVRDisplays().then(function(displays){var vrDisplay=null;for(var i=0;i<displays.length;i++){if(displays[i].capabilities.canPresent===false)continue;vrDisplay=displays[i];break}if(vrDisplay===null){console.warn("No devices available able to present.");return}console.log("vrDisplay",vrDisplay);_this._webvrRecorder.setVRDisplay(vrDisplay);_this._webvrRecorder.start()})}};THREEx.VRRecorder.prototype.stop=function(){if(this._webvrRecorder){this._webvrRecorder.setVRDisplay(null);this._webvrRecorder.stop()}if(this._gamepadRecorder){this._gamepadRecorder.stop()}};var VRRecording={};VRRecording.play=function(experienceUrl,camera,mode){console.assert(mode==="edit"||mode==="play");var vrPlayer=new THREEx.VRPlayer;var vrPlayerUI=new THREEx.VRPlayerUI(vrPlayer);document.body.appendChild(vrPlayerUI.domElement);var matches=experienceUrl.match(/(.*\/)([^\/]+)/);var experienceBasename=matches[2];var experiencePath=matches[1];vrPlayer.load(experiencePath,experienceBasename,function onLoaded(){vrPlayer.start();if(mode==="play"){if(vrPlayer.vrExperience.camera!==undefined){camera.position.fromArray(vrPlayer.vrExperience.camera.position);camera.quaternion.fromArray(vrPlayer.vrExperience.camera.quaternion)}}else if(mode==="edit"){controls=new THREE.OrbitControls(camera,renderer.domElement);controls.enableKeys=false;controls.zoomSpeed=.1;controls.rotateSpeed=.5}else{console.assert(false)}});var clock=new THREE.Clock;requestAnimationFrame(function render(){var delta=clock.getDelta();requestAnimationFrame(render);if(vrPlayer.isStarted()){vrPlayer.update(delta)}vrPlayerUI.update()});return vrPlayer};VRRecording.record=function(options){var vrRecorder=new THREEx.VRRecorder(options);vrRecorder.start();window.vrRecorder=vrRecorder;return vrRecorder};(function(root,factory){if(typeof define==="function"&&define.amd){define([],factory)}else if(typeof exports==="object"){module.exports=factory()}else{root.download=factory()}})(this,function(){return function download(data,strFileName,strMimeType){var self=window,defaultMime="application/octet-stream",mimeType=strMimeType||defaultMime,payload=data,url=!strFileName&&!strMimeType&&payload,anchor=document.createElement("a"),toString=function(a){return String(a)},myBlob=self.Blob||self.MozBlob||self.WebKitBlob||toString,fileName=strFileName||"download",blob,reader;myBlob=myBlob.call?myBlob.bind(self):Blob;if(String(this)==="true"){payload=[payload,mimeType];mimeType=payload[0];payload=payload[1]}if(url&&url.length<2048){fileName=url.split("/").pop().split("?")[0];anchor.href=url;if(anchor.href.indexOf(url)!==-1){var ajax=new XMLHttpRequest;ajax.open("GET",url,true);ajax.responseType="blob";ajax.onload=function(e){download(e.target.response,fileName,defaultMime)};setTimeout(function(){ajax.send()},0);return ajax}}if(/^data\:[\w+\-]+\/[\w+\-]+[,;]/.test(payload)){if(payload.length>1024*1024*1.999&&myBlob!==toString){payload=dataUrlToBlob(payload);mimeType=payload.type||defaultMime}else{return navigator.msSaveBlob?navigator.msSaveBlob(dataUrlToBlob(payload),fileName):saver(payload)}}blob=payload instanceof myBlob?payload:new myBlob([payload],{type:mimeType});function dataUrlToBlob(strUrl){var parts=strUrl.split(/[:;,]/),type=parts[1],decoder=parts[2]=="base64"?atob:decodeURIComponent,binData=decoder(parts.pop()),mx=binData.length,i=0,uiArr=new Uint8Array(mx);for(i;i<mx;++i)uiArr[i]=binData.charCodeAt(i);return new myBlob([uiArr],{type:type})}function saver(url,winMode){if("download"in anchor){anchor.href=url;anchor.setAttribute("download",fileName);anchor.className="download-js-link";anchor.innerHTML="downloading...";anchor.style.display="none";document.body.appendChild(anchor);setTimeout(function(){anchor.click();document.body.removeChild(anchor);if(winMode===true){setTimeout(function(){self.URL.revokeObjectURL(anchor.href)},250)}},66);return true}if(/(Version)\/(\d+)\.(\d+)(?:\.(\d+))?.*Safari\//.test(navigator.userAgent)){url=url.replace(/^data:([\w\/\-\+]+)/,defaultMime);if(!window.open(url)){if(confirm("Displaying New Document\n\nUse Save As... to download, then click back to return to this page.")){location.href=url}}return true}var f=document.createElement("iframe");document.body.appendChild(f);if(!winMode){url="data:"+url.replace(/^data:([\w\/\-\+]+)/,defaultMime)}f.src=url;setTimeout(function(){document.body.removeChild(f)},333)}if(navigator.msSaveBlob){return navigator.msSaveBlob(blob,fileName)}if(self.URL){saver(self.URL.createObjectURL(blob),true)}else{if(typeof blob==="string"||blob.constructor===toString){try{return saver("data:"+mimeType+";base64,"+self.btoa(blob))}catch(y){return saver("data:"+mimeType+","+encodeURIComponent(blob))}}reader=new FileReader;reader.onload=function(e){saver(this.result)};reader.readAsDataURL(blob)}return true}});
