var WebVRPolyfill=function(){};WebVRPolyfill.prototype.install=function(){var framedataProvider=null;this.setFrameDataProvider=function(newFrameDataProvider){framedataProvider=newFrameDataProvider};navigator.getVRDisplays=function(){var vrDisplays=[new VRDisplay];return new Promise(function(resolve,reject){resolve(vrDisplays)})};window.VRFrameData=function(){var frameData=this;this.timestamp=Date.now();this.leftProjectionMatrix=new Float32Array(16);this.leftViewMatrix=new Float32Array(16);this.rightProjectionMatrix=new Float32Array(16);this.rightViewMatrix=new Float32Array(16);this.pose={};this.pose.position=new Float32Array([0,0,0]);this.pose.orientation=new Float32Array([0,0,0,1])};window.VREyeParameters=function(whichEye){this.offset=new Float32Array([0,0,0]);if(whichEye==="right"){this.offset[0]=+.03}else if(whichEye==="left"){this.offset[0]=-.03}else{console.assert(false)}this.fieldOfView={upDegrees:+30,rightDegrees:+30,downDegrees:-30,leftDegrees:-30};this.renderWidth=window.innerWidth/2;this.renderHeight=window.innerHeight};window.VRDisplay=function(){this.isConnected=true;this.isPresenting=false;this.displayId=0;this.displayName="Generic WebVR Polyfill";this.depthNear=.1;this.depthFar=1e4;this.capabilities={hasPosition:true,hasOrientation:true,hasExternalDisplay:false,canPresent:true,maxLayers:1};this.stageParameters={sittingToStandingTransform:new Float32Array(16),sizeX:3,sizeY:3}};VRDisplay.prototype.getFrameData=function(frameData){if(!framedataProvider)return;framedataProvider.updateFrameData(frameData)};VRDisplay.prototype.getEyeParameters=function(whichEye){return new VREyeParameters(whichEye)};VRDisplay.prototype.getPose=function(){console.assert("not yet implemented, Deprecated anyway")};VRDisplay.prototype.resetPose=function(frameData){console.assert("not yet implemented");if(!framedataProvider)return;framedataProvider.resetPose()};VRDisplay.prototype.requestAnimationFrame=function(callback){return window.requestAnimationFrame(callback)};VRDisplay.prototype.cancelAnimationFrame=function(handle){return window.cancelAnimationFrame(handle)};VRDisplay.prototype.getLayers=function(){return[]};VRDisplay.prototype.requestPresent=function(layers){var _this=this;this._layers=layers;console.log("requestPresent");return new Promise(function(resolve,reject){loop();return;function loop(){if(framedataProvider.started===true){completed();return}setTimeout(loop,1e3/10)}function completed(){_this.isPresenting=true;console.log("dispatch vrdisplaypresentchange on requestPresent");var event=new Event("vrdisplaypresentchange");window.dispatchEvent(event);resolve()}})};VRDisplay.prototype.exitPresent=function(){var _this=this;console.log("exitPresent");return new Promise(function(resolve,reject){_this.isPresenting=false;console.log("dispatch vrdisplaypresentchange on exitPresent");var event=new Event("vrdisplaypresentchange");window.dispatchEvent(event);resolve()})};VRDisplay.prototype.submitFrame=function(){};return this};var THREEx=THREEx||{};THREEx.JsonPlayer=function(onNewRecord){var _this=this;_this.records=null;_this.playbackRate=1;this.currentTime=0;this.started=false;this.paused=false;this.start=function(){console.assert(this.started===false);this.started=true;this.paused=false;onCurrentTimeChange()};this.stop=function(){this.started=false;this.paused=false};this.isStarted=function(){return _this.started};this.pause=function(onOff){_this.paused=onOff};this.update=function(deltaTime){if(this.isStarted()===false)return;if(_this.paused===false){_this.currentTime+=deltaTime*_this.playbackRate}onCurrentTimeChange()};this.onCurrentTimeChange=onCurrentTimeChange;return;function onCurrentTimeChange(){if(_this.records===null)return;var timestamp=_this.records.startedAt+_this.currentTime*1e3;var values=_this.records.values;for(var i=0;i<values.length;i++){if(i+1>=values.length)break;if(values[i+1].recordedAt>timestamp){onNewRecord(values[i].data);break}}}};THREEx.JsonPlayer.prototype.load=function(urls,onLoaded){var _this=this;loadNextUrl();return;function loadNextUrl(){if(urls.length===0){onLoaded();return}var url=urls.shift();doHttpRequest(url,function(content){var loadedRecords=JSON.parse(content);if(_this.records===null){_this.records=loadedRecords}else{_this.records.values.push.apply(_this.records.values,loadedRecords.values)}loadNextUrl()})}return;function doHttpRequest(url,onLoaded){var request=new XMLHttpRequest;request.addEventListener("load",function(){onLoaded(this.responseText)});request.open("GET",url);request.send()}};var THREEx=THREEx||{};THREEx.JsonRecorder=function(fetchNewRecord){var _this=this;this.autoSave=true;this.autoSaveMaxLength=1e3;this.autoSaveBaseName="jsonrecords";this.updatePeriod=1e3/100;this.autoSaveCounter=0;var records={startedAt:null,values:[]};var timerId=null;this.start=function(){records.startedAt=Date.now();this.autoSaveCounter=0;console.assert(timerId===null);timerId=setInterval(update,_this.updatePeriod);return this};this.stop=function(){if(_this.autoSave===true)autoSave();clearInterval(timerId);timerId=null;return this};return;function update(){var recordData=fetchNewRecord();records.values.push({recordedAt:Date.now(),data:recordData});if(_this.autoSave===true&&records.values.length>=_this.autoSaveMaxLength){autoSave()}}function autoSave(){var basename=_this.autoSaveBaseName+pad(_this.autoSaveCounter,4)+".json";var jsonString=JSON.stringify(records,null,"	");download(jsonString,basename,"application/json");_this.autoSaveCounter++;records.startedAt=Date.now();records.values=[]}function pad(num,size){var s=num+"";while(s.length<size)s="0"+s;return s}};var THREEx=THREEx||{};THREEx.WebvrPlayer=function(){var _this=this;THREEx.JsonPlayer.call(this,function onNewRecord(frameData){_this.frameData=frameData});this.frameData=null};THREEx.WebvrPlayer.prototype=Object.create(THREEx.JsonPlayer.prototype);THREEx.WebvrPlayer.prototype.constructor=THREEx.WebvrPlayer;var THREEx=THREEx||{};THREEx.GamepadPlayer=function(){var _this=this;THREEx.JsonPlayer.call(this,function onNewRecord(newRecord){_this.gamepads=newRecord});this.gamepads=[null,null,null,null]};THREEx.GamepadPlayer.prototype=Object.create(THREEx.JsonPlayer.prototype);THREEx.GamepadPlayer.prototype.constructor=THREEx.GamepadPlayer;var THREEx=THREEx||{};THREEx.WebvrRecorder=function(){var _this=this;THREEx.JsonRecorder.call(this,function fetchNewRecord(newRecord){_this._vrDisplay.getFrameData(frameData);var frameDataJSON=JSON.parse(JSON.stringify(frameData));return frameDataJSON});this.autoSaveBaseName="webvrrecords";var frameData=new VRFrameData;this._vrDisplay=null;this.setVRDisplay=function(vrDisplay){this._vrDisplay=vrDisplay;return this}};THREEx.WebvrRecorder.prototype=Object.create(THREEx.JsonRecorder.prototype);THREEx.WebvrRecorder.prototype.constructor=THREEx.WebvrRecorder;var THREEx=THREEx||{};THREEx.GamepadRecorder=function(){THREEx.JsonRecorder.call(this,function fetchNewRecord(newRecord){var gamepads=navigator.getGamepads();var gamepadsJSON=THREEx.GamepadRecorder._cloneObject(gamepads);return gamepadsJSON});this.autoSaveBaseName="gamepadrecords";return};THREEx.GamepadRecorder.prototype=Object.create(THREEx.JsonRecorder.prototype);THREEx.GamepadRecorder.prototype.constructor=THREEx.GamepadRecorder;THREEx.GamepadRecorder._cloneObject=function(item){var _this=this;if(!item){return item}var types=[Number,String,Boolean],result;types.forEach(function(type){if(item instanceof type){result=type(item)}});if(typeof result=="undefined"){if(Object.prototype.toString.call(item)==="[object Array]"){result=[];item.forEach(function(child,index,array){result[index]=_this._cloneObject(child)})}else if(typeof item=="object"){if(item.nodeType&&typeof item.cloneNode=="function"){var result=item.cloneNode(true)}else if(!item.prototype){if(item instanceof Date){result=new Date(item)}else{result={};for(var i in item){result[i]=_this._cloneObject(item[i])}}}else{if(false&&item.constructor){result=new item.constructor}else{result=item}}}else{result=item}}return result};var THREEx=THREEx||{};THREEx.VRPlayer=function(){var _this=this;this.vrExperience=null;this._playbackRate=1;this.videoElement=document.createElement("video");this.videoElement.style.position="absolute";this.videoElement.style.top="0px";this.videoElement.style.left="0px";this.videoElement.style.zIndex="-1";this.videoElement.muted=true;this.videoElement.playbackRate=this._playbackRate;this._webvrPlayer=new THREEx.WebvrPlayer;this._webvrPlayer.playbackRate=this._playbackRate;this._gamepadPlayer=new THREEx.GamepadPlayer;this._gamepadPlayer.playbackRate=this._playbackRate;navigator.getGamepads=function(){return _this._gamepadPlayer.gamepads};var webvrPolyfill=(new WebVRPolyfill).install();var frameDataProvider=new FrameDataProviderWebvr(this._webvrPlayer);webvrPolyfill.setFrameDataProvider(frameDataProvider)};THREEx.VRPlayer.prototype.setPlaybackRate=function(playbackRate){this._playbackRate=playbackRate;this.videoElement.playbackRate=playbackRate;this._webvrPlayer.playbackRate=playbackRate;this._gamepadPlayer.playbackRate=playbackRate;return this};THREEx.VRPlayer.prototype.load=function(path,basename,onLoaded){var _this=this;doHttpRequest(path+basename,function(data){var vrExperience=JSON.parse(data);_this.vrExperience=vrExperience;_this.path=path;var webvrUrls=[];for(var i=0;i<_this.vrExperience.nWebvrFiles;i++){webvrUrls.push(_this.path+_this.vrExperience.webvrBaseUrl+pad(i,4)+".json")}var webvrLoaded=false;_this._webvrPlayer.load(webvrUrls,function(){webvrLoaded=true;if(webvrLoaded&&gamepadLoaded)onLoaded()});var gamepadUrls=[];for(var i=0;i<_this.vrExperience.nGamepadFiles;i++){gamepadUrls.push(_this.path+_this.vrExperience.gamepadBaseUrl+pad(i,4)+".json")}var gamepadLoaded=false;_this._gamepadPlayer.load(gamepadUrls,function(){gamepadLoaded=true;if(webvrLoaded&&gamepadLoaded)onLoaded()})});return this;function doHttpRequest(url,onLoaded){var request=new XMLHttpRequest;request.addEventListener("load",function(){onLoaded(this.responseText)});request.open("GET",url);request.send()}function pad(num,size){var string=num+"";while(string.length<size)string="0"+string;return string}};THREEx.VRPlayer.prototype.start=function(){var _this=this;this.videoElement.src=this.path+this.vrExperience.videoSrc;this.videoElement.play();this._webvrPlayer.start();this._gamepadPlayer.start();this.setCurrentTime(0);return this};THREEx.VRPlayer.prototype.isStarted=function(){return this._gamepadPlayer.isStarted()};THREEx.VRPlayer.prototype.isPaused=function(){return this._gamepadPlayer.paused};THREEx.VRPlayer.prototype.getCurrentTime=function(){return this.videoElement.currentTime};THREEx.VRPlayer.prototype.setCurrentTime=function(currentTime){this.videoElement.currentTime=currentTime;this._webvrPlayer.currentTime=currentTime-this.vrExperience.videoToWebvrDelay;this._webvrPlayer.onCurrentTimeChange();this._gamepadPlayer.currentTime=currentTime-this.vrExperience.videoToGamepadDelay;this._gamepadPlayer.onCurrentTimeChange()};THREEx.VRPlayer.prototype.seek=function(delta){var currentTime=this.videoElement.currentTime;currentTime+=delta;this.setCurrentTime(currentTime)};THREEx.VRPlayer.prototype.pause=function(value){if(value===undefined){value=this._gamepadPlayer.paused?false:true}if(value===true){this.videoElement.pause()}else{if(this.videoElement.paused){this.videoElement.play()}}this._webvrPlayer.pause(value);this._gamepadPlayer.pause(value)};THREEx.VRPlayer.prototype.update=function(deltaTime){this._webvrPlayer.update(deltaTime);this._gamepadPlayer.update(deltaTime)};function FrameDataProviderWebvr(webvrPlayer){var _this=this;_this.started=true;this.resetPose=function(){};this.dispose=function(){};this.updateFrameData=function(dstFrameData){var srcFrameData=webvrPlayer.frameData;if(srcFrameData===null)return;dstFrameData.timestamp=srcFrameData.timestamp;copyArray(srcFrameData.leftProjectionMatrix,dstFrameData.leftProjectionMatrix,16);copyArray(srcFrameData.rightProjectionMatrix,dstFrameData.rightProjectionMatrix,16);copyArray(srcFrameData.leftViewMatrix,dstFrameData.leftViewMatrix,16);copyArray(srcFrameData.rightViewMatrix,dstFrameData.rightViewMatrix,16);copyArray(srcFrameData.pose.position,dstFrameData.pose.position,3);copyArray(srcFrameData.pose.orientation,dstFrameData.pose.orientation,3);function copyArray(srcArray,dstArray,len){for(var i=0;i<len;i++){dstArray[i]=srcArray[i]}}}}var THREEx=THREEx||{};THREEx.VRPlayerUI=function(vrPlayer){this.vrPlayer=vrPlayer;this.domElement=document.createElement("div");this.domElement.style.fontFamily="monospace";this.domElement.style.color="black";this.domElement.style.padding="0.5em";this.domElement.style.margin="0.5em";this.domElement.style.position="fixed";this.domElement.style.top="0px";this.domElement.style.right="0px";this.domElement.style.zIndex=9999;this.domElement.style.borderRadius="1em";this.domElement.style.borderStyle="solid";this.domElement.style.backgroundColor="lightgrey";var titleElement=document.createElement("h2");titleElement.innerHTML="VRPlayer";this.domElement.appendChild(titleElement);var startButton=document.createElement("button");startButton.innerHTML="start";this.domElement.appendChild(startButton);startButton.addEventListener("click",function(){vrPlayer.start()});var pauseButton=document.createElement("button");pauseButton.innerHTML="pause";this.domElement.appendChild(pauseButton);pauseButton.addEventListener("click",function(){vrPlayer.pause()});this.domElement.appendChild(document.createElement("br"));var seekMinusOneButton=document.createElement("button");seekMinusOneButton.innerHTML="seek -1sec";this.domElement.appendChild(seekMinusOneButton);seekMinusOneButton.addEventListener("click",function(){vrPlayer.seek(-1)});var seekPlusOneButton=document.createElement("button");seekPlusOneButton.innerHTML="seek +1sec";this.domElement.appendChild(seekPlusOneButton);seekPlusOneButton.addEventListener("click",function(){vrPlayer.seek(+1)});this.domElement.appendChild(document.createElement("br"));var labelElement=document.createElement("label");labelElement.innerHTML="current time : ";this.domElement.appendChild(labelElement);var currentTimeValue=document.createElement("span");currentTimeValue.innerHTML="n/a";labelElement.appendChild(currentTimeValue);this.domElement.appendChild(document.createElement("br"));var labelElement=document.createElement("label");labelElement.innerHTML="video duration : ";this.domElement.appendChild(labelElement);var videoDurationValue=document.createElement("span");videoDurationValue.innerHTML="n/a";labelElement.appendChild(videoDurationValue);this.domElement.appendChild(document.createElement("br"));var labelElement=document.createElement("label");labelElement.innerHTML="gamepad time offset : ";this.domElement.appendChild(labelElement);var gamepadTimeOffsetValue=document.createElement("span");gamepadTimeOffsetValue.innerHTML="n/a";labelElement.appendChild(gamepadTimeOffsetValue);this.domElement.appendChild(document.createElement("br"));var labelElement=document.createElement("label");labelElement.innerHTML="gamepad time offset : ";this.domElement.appendChild(labelElement);var gamepadTimeOffsetInput=document.createElement("input");gamepadTimeOffsetInput.size="4";gamepadTimeOffsetInput.innerHTML="n/a";labelElement.appendChild(gamepadTimeOffsetInput);gamepadTimeOffsetInput.addEventListener("change",function(){var value=parseFloat(gamepadTimeOffsetInput.value);vrPlayer.vrExperience.videoToGamepadDelay=value;vrPlayer.seek(0)});this.domElement.appendChild(document.createElement("br"));var labelElement=document.createElement("label");labelElement.innerHTML="webvr time offset : ";this.domElement.appendChild(labelElement);var webvrTimeOffsetValue=document.createElement("span");webvrTimeOffsetValue.innerHTML="n/a";labelElement.appendChild(webvrTimeOffsetValue);this.domElement.appendChild(document.createElement("br"));var labelElement=document.createElement("label");labelElement.innerHTML="webvr time offset : ";this.domElement.appendChild(labelElement);var webvrTimeOffsetInput=document.createElement("input");webvrTimeOffsetInput.size="4";webvrTimeOffsetInput.innerHTML="n/a";labelElement.appendChild(webvrTimeOffsetInput);webvrTimeOffsetInput.addEventListener("change",function(){var value=parseFloat(webvrTimeOffsetInput.value);vrPlayer.vrExperience.videoToWebvrDelay=value;vrPlayer.seek(0)});this.update=function(){if(vrPlayer.isStarted()){startButton.disabled=true}else{startButton.disabled=false}currentTimeValue.innerHTML=vrPlayer.getCurrentTime().toFixed(2)+"sec";if(vrPlayer.vrExperience!==null){gamepadTimeOffsetValue.innerHTML=vrPlayer.vrExperience.videoToGamepadDelay}if(vrPlayer.vrExperience!==null){webvrTimeOffsetValue.innerHTML=vrPlayer.vrExperience.videoToWebvrDelay}videoDurationValue.innerHTML=vrPlayer.videoElement.duration.toFixed(2)+"sec"}};var THREEx=THREEx||{};THREEx.VRRecorder=function(options){options=options||{};options.gamepad=options.gamepad!==undefined?options.gamepad:true;options.webvr=options.webvr!==undefined?options.webvr:true;this._isStarted=false;if(options.gamepad===true){this._gamepadRecorder=new THREEx.GamepadRecorder}else{this._gamepadRecorder=null}if(options.webvr===true){this._webvrRecorder=new THREEx.WebvrRecorder}else{this._webvrRecorder=null}};THREEx.VRRecorder.prototype.start=function(){var _this=this;this._isStarted=true;if(_this._gamepadRecorder!==null){_this._gamepadRecorder.start()}if(_this._webvrRecorder!==null){navigator.getVRDisplays().then(function(displays){var vrDisplay=null;for(var i=0;i<displays.length;i++){if(displays[i].capabilities.canPresent===false)continue;vrDisplay=displays[i];break}if(vrDisplay===null){console.error("No devices available able to present.");return}_this._webvrRecorder.setVRDisplay(vrDisplay);_this._webvrRecorder.start()})}};THREEx.VRRecorder.prototype.stop=function(){this._isStarted=false;if(this._webvrRecorder){this._webvrRecorder.setVRDisplay(null);this._webvrRecorder.stop()}if(this._gamepadRecorder){this._gamepadRecorder.stop()}var vrExperience={videoSrc:"/your/video/file/goeshere.m4v",camera:{position:[0,0,0],quaternion:[0,0,0,1]},nWebvrFiles:this._webvrRecorder?this._webvrRecorder.autoSaveCounter:0,videoToWebvrDelay:0,webvrBaseUrl:"webvrrecords",nGamepadFiles:this._gamepadRecorder?this._gamepadRecorder.autoSaveCounter:0,videoToGamepadDelay:0,gamepadBaseUrl:"gamepadrecords"};var jsonString=JSON.stringify(vrExperience,null,"	");download(jsonString,"vr-experience.json","application/json")};THREEx.VRRecorder.prototype.isStarted=function(){return this._isStarted};var THREEx=THREEx||{};THREEx.VRRecorderUI=function(vrRecorder){this.vrRecorder=vrRecorder;this.domElement=document.createElement("div");this.domElement.style.fontFamily="monospace";this.domElement.style.color="black";this.domElement.style.padding="0.5em";this.domElement.style.margin="0.5em";this.domElement.style.position="fixed";this.domElement.style.top="0px";this.domElement.style.right="0px";this.domElement.style.zIndex=9999;this.domElement.style.borderRadius="1em";this.domElement.style.borderStyle="solid";this.domElement.style.backgroundColor="lightgrey";var titleElement=document.createElement("h2");titleElement.innerHTML="VRRecorder";this.domElement.appendChild(titleElement);var startButton=document.createElement("button");startButton.innerHTML="start";this.domElement.appendChild(startButton);startButton.addEventListener("click",function(){vrRecorder.start()});var stopButton=document.createElement("button");stopButton.innerHTML="stop";this.domElement.appendChild(stopButton);stopButton.addEventListener("click",function(){vrRecorder.stop()});this.update=function(){if(vrRecorder.isStarted()){startButton.disabled=true;stopButton.disabled=false}else{startButton.disabled=false;stopButton.disabled=true}}};var VRRecording={};VRRecording.play=function(experienceUrl,camera,mode){console.assert(mode==="edit"||mode==="play");var vrPlayer=new THREEx.VRPlayer;document.body.appendChild(vrPlayer.videoElement);var vrPlayerUI=new THREEx.VRPlayerUI(vrPlayer);document.body.appendChild(vrPlayerUI.domElement);var matches=experienceUrl.match(/(.*\/)([^\/]+)/);var experienceBasename=matches[2];var experiencePath=matches[1];vrPlayer.load(experiencePath,experienceBasename,function onLoaded(){vrPlayer.start();if(mode==="play"){if(vrPlayer.vrExperience.fixedCamera!==undefined&&camera!==undefined){camera.position.fromArray(vrPlayer.vrExperience.fixedCamera.position);camera.quaternion.fromArray(vrPlayer.vrExperience.fixedCamera.quaternion)}}else if(mode==="edit"){controls=new THREE.OrbitControls(camera,renderer.domElement);controls.enableKeys=false;controls.zoomSpeed=.1;controls.rotateSpeed=.5}else{console.assert(false)}});var lastTime=null;requestAnimationFrame(function render(now){requestAnimationFrame(render);var deltaTime=lastTime===null?1e3/60:now-lastTime;lastTime=now;if(vrPlayer.isStarted()){vrPlayer.update(deltaTime/1e3)}vrPlayerUI.update()});return vrPlayer};VRRecording.record=function(options){var vrRecorder=new THREEx.VRRecorder(options);var vrRecorderUI=new THREEx.VRRecorderUI(vrRecorder);document.body.appendChild(vrRecorderUI.domElement);requestAnimationFrame(function render(){requestAnimationFrame(render);vrRecorderUI.update()});return vrRecorder};(function(root,factory){if(typeof define==="function"&&define.amd){define([],factory)}else if(typeof exports==="object"){module.exports=factory()}else{root.download=factory()}})(this,function(){return function download(data,strFileName,strMimeType){var self=window,defaultMime="application/octet-stream",mimeType=strMimeType||defaultMime,payload=data,url=!strFileName&&!strMimeType&&payload,anchor=document.createElement("a"),toString=function(a){return String(a)},myBlob=self.Blob||self.MozBlob||self.WebKitBlob||toString,fileName=strFileName||"download",blob,reader;myBlob=myBlob.call?myBlob.bind(self):Blob;if(String(this)==="true"){payload=[payload,mimeType];mimeType=payload[0];payload=payload[1]}if(url&&url.length<2048){fileName=url.split("/").pop().split("?")[0];anchor.href=url;if(anchor.href.indexOf(url)!==-1){var ajax=new XMLHttpRequest;ajax.open("GET",url,true);ajax.responseType="blob";ajax.onload=function(e){download(e.target.response,fileName,defaultMime)};setTimeout(function(){ajax.send()},0);return ajax}}if(/^data\:[\w+\-]+\/[\w+\-]+[,;]/.test(payload)){if(payload.length>1024*1024*1.999&&myBlob!==toString){payload=dataUrlToBlob(payload);mimeType=payload.type||defaultMime}else{return navigator.msSaveBlob?navigator.msSaveBlob(dataUrlToBlob(payload),fileName):saver(payload)}}blob=payload instanceof myBlob?payload:new myBlob([payload],{type:mimeType});function dataUrlToBlob(strUrl){var parts=strUrl.split(/[:;,]/),type=parts[1],decoder=parts[2]=="base64"?atob:decodeURIComponent,binData=decoder(parts.pop()),mx=binData.length,i=0,uiArr=new Uint8Array(mx);for(i;i<mx;++i)uiArr[i]=binData.charCodeAt(i);return new myBlob([uiArr],{type:type})}function saver(url,winMode){if("download"in anchor){anchor.href=url;anchor.setAttribute("download",fileName);anchor.className="download-js-link";anchor.innerHTML="downloading...";anchor.style.display="none";document.body.appendChild(anchor);setTimeout(function(){anchor.click();document.body.removeChild(anchor);if(winMode===true){setTimeout(function(){self.URL.revokeObjectURL(anchor.href)},250)}},66);return true}if(/(Version)\/(\d+)\.(\d+)(?:\.(\d+))?.*Safari\//.test(navigator.userAgent)){url=url.replace(/^data:([\w\/\-\+]+)/,defaultMime);if(!window.open(url)){if(confirm("Displaying New Document\n\nUse Save As... to download, then click back to return to this page.")){location.href=url}}return true}var f=document.createElement("iframe");document.body.appendChild(f);if(!winMode){url="data:"+url.replace(/^data:([\w\/\-\+]+)/,defaultMime)}f.src=url;setTimeout(function(){document.body.removeChild(f)},333)}if(navigator.msSaveBlob){return navigator.msSaveBlob(blob,fileName)}if(self.URL){saver(self.URL.createObjectURL(blob),true)}else{if(typeof blob==="string"||blob.constructor===toString){try{return saver("data:"+mimeType+";base64,"+self.btoa(blob))}catch(y){return saver("data:"+mimeType+","+encodeURIComponent(blob))}}reader=new FileReader;reader.onload=function(e){saver(this.result)};reader.readAsDataURL(blob)}return true}});
